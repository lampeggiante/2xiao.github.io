import{_ as e,r as p,o,c,a as s,b as n,d as i,e as a}from"./app-ME_WE59V.js";const l="/assets/vue-1-jEuDZC5t.png",u="/assets/vue-2-GO20mewv.png",r="/assets/vue-3-O-Nj9OA8.png",d={},k=a('<h1 id="_2-开发环境搭建" tabindex="-1"><a class="header-anchor" href="#_2-开发环境搭建" aria-hidden="true">#</a> 2. 开发环境搭建</h1><h2 id="vue3-项目结构" tabindex="-1"><a class="header-anchor" href="#vue3-项目结构" aria-hidden="true">#</a> Vue3 项目结构</h2><figure><img src="'+l+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="'+u+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="搭建-monorepo-环境" tabindex="-1"><a class="header-anchor" href="#搭建-monorepo-环境" aria-hidden="true">#</a> 搭建 Monorepo 环境</h2><p>Monorepo 是管理项目代码的一个方式，指在一个项目仓库(repo)中管理多个模块/包(package)。 Vue3 源码采用 monorepo 方式进行管理，将模块拆分到 package 目录中。作为一个个包来管理，这样职责划分更加明确。</p><ul><li>一个仓库可维护多个模块，不用到处找仓库</li><li>方便版本管理和依赖管理，模块之间的引用，调用都非常方便</li></ul>',7),m=s("code",null,"pnpm",-1),v=s("code",null,"workspace",-1),b=s("code",null,"monorepo",-1),g={href:"https://pnpm.io/",target:"_blank",rel:"noopener noreferrer"},q=a(`<h3 id="_1-全局安装-pnpm" tabindex="-1"><a class="header-anchor" href="#_1-全局安装-pnpm" aria-hidden="true">#</a> 1.全局安装 pnpm</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> <span class="token function">pnpm</span> <span class="token parameter variable">-g</span> <span class="token comment"># 全局安装pnpm</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">pnpm</span> init  <span class="token comment"># 初始化配置文件</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-创建-npmrc-文件" tabindex="-1"><a class="header-anchor" href="#_2-创建-npmrc-文件" aria-hidden="true">#</a> 2.创建.npmrc 文件</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>shamefully-hoist <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>这里您可以尝试一下安装<code>Vue3</code>, <code>pnpm install vue</code>此时默认情况下<code>vue3</code>中依赖的模块不会被提升到<code>node_modules</code>下。 添加<strong>羞耻的提升</strong>可以将 Vue3，所依赖的模块提升到<code>node_modules</code>中</p></blockquote><h3 id="_3-配置-workspace" tabindex="-1"><a class="header-anchor" href="#_3-配置-workspace" aria-hidden="true">#</a> 3.配置 workspace</h3><p>新建 <strong>pnpm-workspace.yaml</strong></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>packages<span class="token operator">:</span>
    - <span class="token string">&quot;packages/*&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>将 packages 下所有的目录都作为包进行管理。这样我们的 Monorepo 就搭建好了。确实比<code>lerna + yarn workspace</code>更快捷</p></blockquote><h3 id="_4-环境搭建" tabindex="-1"><a class="header-anchor" href="#_4-环境搭建" aria-hidden="true">#</a> 4.环境搭建</h3><blockquote><p>打包项目 Vue3 采用 rollup 进行打包代码，安装打包所需要的依赖</p></blockquote><table><thead><tr><th>开发依赖</th><th></th></tr></thead><tbody><tr><td>typescript</td><td>在项目中支持 Typescript</td></tr><tr><td>esbuild</td><td>构建工具，默认支持 TS</td></tr><tr><td>minimist</td><td>命令行参数解析</td></tr></tbody></table><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">pnpm</span> <span class="token function">install</span> typescript minimist esbuild <span class="token parameter variable">-D</span> <span class="token parameter variable">-w</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_5-初始化-ts" tabindex="-1"><a class="header-anchor" href="#_5-初始化-ts" aria-hidden="true">#</a> 5.初始化 TS</h3><p>复杂的框架项目开发，使用类型语言非常有利于代码的维护，在编码期间就可以帮我们做类型检查，避免错误。所以 TS 已经是主流框架的标配~</p><blockquote><p>Vue2 早期采用 Flow 来进行类型检测 （Vue2 中对 TS 支持并不友好）， Vue3 源码采用 Typescript 来进行重写。同时 Vue2.7 也采用 TS 进行重写。TS 能对代码提供良好的类型检查，同时也支持复杂的类型推导。</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">pnpm</span> tsc <span class="token parameter variable">--init</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>先添加些常用的<code>ts-config</code>配置，后续需要其他的在继续增加</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;outDir&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 输出的目录</span>
		<span class="token property">&quot;sourceMap&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 采用sourcemap</span>
		<span class="token property">&quot;target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es2016&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 目标语法</span>
		<span class="token property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;esnext&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 模块格式</span>
		<span class="token property">&quot;moduleResolution&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 模块解析方式</span>
		<span class="token property">&quot;strict&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 严格模式</span>
		<span class="token property">&quot;resolveJsonModule&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 解析json模块</span>
		<span class="token property">&quot;esModuleInterop&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 允许通过es6语法引入commonjs模块</span>
		<span class="token property">&quot;jsx&quot;</span><span class="token operator">:</span> <span class="token string">&quot;preserve&quot;</span><span class="token punctuation">,</span> <span class="token comment">// jsx 不转义</span>
		<span class="token property">&quot;lib&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;esnext&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dom&quot;</span><span class="token punctuation">]</span> <span class="token comment">// 支持的类库 esnext及dom</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-创建模块" tabindex="-1"><a class="header-anchor" href="#_6-创建模块" aria-hidden="true">#</a> 6.创建模块</h3><blockquote><p>我们现在<code>packages</code>目录下新建两个 package，用于下一章手写响应式原理做准备</p></blockquote><ul><li><code>reactivity</code> 响应式模块</li><li><code>shared</code> 共享模块</li></ul><p><strong>所有包的入口均为<code>src/index.ts</code> 这样可以实现统一打包</strong></p><ul><li><code>reactivity/package.json</code></li></ul><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@vue/reactivity&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/reactivity.esm-bundler.js&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;unpkg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/reactivity.global.js&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;buildOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VueReactivity&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;formats&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;esm-bundler&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cjs&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;global&quot;</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>shared/package.json</code></li></ul><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@vue/shared&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/shared.esm-bundler.js&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;buildOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;formats&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;esm-bundler&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cjs&quot;</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>formats</code> 为自定义的打包格式</p></blockquote><ul><li><code>global</code> 立即执行函数的格式，会暴露全局对象</li><li><code>esm-browser</code> 在浏览器中使用的格式，内联所有的依赖项。</li><li><code>esm-bundler</code> 在构建工具中使用的格式，不提供 <code>.prod</code> 格式，在构建应用程序时会被构建工具一起进行打包压缩。</li><li><code>cjs</code> 在 <code>node</code> 中使用的格式，服务端渲染。</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">pnpm</span> <span class="token function">install</span> @vue/shared <span class="token parameter variable">--workspace</span> <span class="token parameter variable">--filter</span> @vue/reactivity
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>配置<code>ts</code>引用关系</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token property">&quot;baseUrl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;paths&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@vue/*&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;packages/*/src&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-开发环境esbuild打包" tabindex="-1"><a class="header-anchor" href="#_7-开发环境esbuild打包" aria-hidden="true">#</a> 7.开发环境<code>esbuild</code>打包</h3><figure><img src="`+r+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>创建开发时执行脚本， 参数为要打包的模块</p><p><strong>解析用户参数</strong></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node scripts/dev.js reactivity -f esm&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> esbuild <span class="token keyword">from</span> <span class="token string">&#39;esbuild&#39;</span><span class="token punctuation">;</span> <span class="token comment">// 打包工具</span>
<span class="token keyword">import</span> minimist <span class="token keyword">from</span> <span class="token string">&#39;minimist&#39;</span><span class="token punctuation">;</span> <span class="token comment">// 命令行参数解析</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> resolve<span class="token punctuation">,</span> dirname <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;path&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fileURLToPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;url&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createRequire <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;module&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> require <span class="token operator">=</span> <span class="token function">createRequire</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可以在es6中使用require语法</span>
<span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">minimist</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析打包格式和打包模块</span>
<span class="token keyword">const</span> format <span class="token operator">=</span> args<span class="token punctuation">.</span>f <span class="token operator">||</span> <span class="token string">&#39;iife&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> args<span class="token punctuation">.</span>_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&#39;reactivity&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// __dirname在es6模块中不存在需要自行解析</span>
<span class="token keyword">const</span> __dirname <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">../packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/package.json</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

esbuild
	<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		<span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">../packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/src/index.ts</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token literal-property property">outfile</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
			<span class="token comment">// 输出的文件</span>
			__dirname<span class="token punctuation">,</span>
			<span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">../packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">\`</span></span>
		<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 全部打包</span>
		<span class="token literal-property property">sourcemap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// sourcemap源码映射</span>
		format<span class="token punctuation">,</span> <span class="token comment">// 打包格式 esm , cjs, iife</span>
		<span class="token literal-property property">globalName</span><span class="token operator">:</span> pkg<span class="token punctuation">.</span>buildOptions<span class="token operator">?.</span>name<span class="token punctuation">,</span> <span class="token comment">// 全局名配置</span>
		<span class="token literal-property property">platform</span><span class="token operator">:</span> <span class="token string">&#39;browser&#39;</span> <span class="token comment">// 平台</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;watching~~~&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 监控文件变化</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,39);function h(y,f){const t=p("ExternalLinkIcon");return o(),c("div",null,[k,s("p",null,[n("Vue3 中使用"),m,n(),v,n("来实现"),b,n(" ("),s("a",g,[n("pnpm"),i(t)]),n("是快速、节省磁盘空间的包管理器。主要采用符号链接的方式管理模块)")]),q])}const x=e(d,[["render",h],["__file","2.html.vue"]]);export{x as default};
